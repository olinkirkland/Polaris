<?xml version="1.0"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
                       xmlns:s="library://ns.adobe.com/flex/spark"
                       width="480"
                       height="860"
                       frameRate="60"
                       showStatusBar="false"
                       creationComplete="onCreationComplete(event)">
    <fx:Style source="../assets/css/global.css" />
    <fx:Script><![CDATA[
        import events.PopupEvent;

        import global.Color;

        import logic.AssetManager;
        import logic.GameState;
        import logic.PopupManager;
        import logic.SaveManager;
        import logic.Signal;

        import mx.events.FlexEvent;

        import ui.popups.LoadingPopup;
        import ui.popups.MainMenuPopup;
        import ui.popups.Popup;

        private function onCreationComplete(event:FlexEvent):void
        {
            addEventListeners();

            PopupManager.open(new LoadingPopup());
            AssetManager.instance.load(onDataManagerLoaded);
            SaveManager.instance.addEventListener(SaveManager.GAME_LOADED, onGameLoaded);
        }

        private function onGameLoaded(event:Event):void
        {
            labelSaveGameName.text = GameState.instance.name;
        }

        private function addEventListeners():void
        {
            Signal.instance.addEventListener(PopupEvent.OPEN, function (event:PopupEvent):void
            {
                openPopup(event.popup);
            });

            Signal.instance.addEventListener(PopupEvent.CLOSE, function (event:PopupEvent):void
            {
                closePopup();
            });
        }

        private function onDataManagerLoaded():void
        {
            PopupManager.close();

            // Start
            start();
        }

        private function start():void
        {
        }

        private function onClickButtonMainMenu(event:MouseEvent):void
        {
            PopupManager.open(new MainMenuPopup());
        }

        private function openPopup(popup:Popup):void
        {
            closePopup();

            modalGroup.visible = true;
            popupGroup.addElement(popup);
        }

        private function closePopup():void
        {
            // Close all existing popups
            // Expect only one popup at a time since popups are designed to be modal only
            modalGroup.visible = false;
            while (popupGroup.numElements > 0)
                Popup(popupGroup.getElementAt(0)).close();
        }
        ]]></fx:Script>
    <s:Group width="100%"
             height="100%">

        <!--Main Menu Button-->
        <s:VGroup width="100%"
                  height="100%"
                  padding="10"
                  horizontalAlign="right">
            <s:HGroup>
                <s:Label id="labelSaveGameName" />
                <s:Button id="buttonMainMenu"
                          label="Menu"
                          click="onClickButtonMainMenu(event)" />
            </s:HGroup>
        </s:VGroup>

        <!--Popups-->
        <s:Group id="modalGroup"
                 width="100%"
                 height="100%">
            <s:Rect width="100%"
                    height="100%">

                <s:fill>
                    <s:SolidColor color="{Color.black}"
                                  alpha=".6" />
                </s:fill>
            </s:Rect>
            <s:VGroup id="popupGroup"
                      width="100%"
                      height="100%"
                      horizontalAlign="center"
                      verticalAlign="middle">
            </s:VGroup>
        </s:Group>

    </s:Group>
</s:WindowedApplication>